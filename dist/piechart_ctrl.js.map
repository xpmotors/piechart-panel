{"version":3,"sources":["../src/piechart_ctrl.js"],"names":["MetricsPanelCtrl","_","kbn","TimeSeries","rendering","legend","PieChartCtrl","$scope","$injector","$rootScope","hiddenSeries","panelDefaults","pieType","show","values","links","datasource","maxDataPoints","interval","targets","cacheTimeout","nullPointMode","legendType","breakPoint","aliasColors","format","valueName","strokeWidth","fontSize","combine","threshold","label","defaults","panel","events","on","onRender","bind","onDataReceived","onDataError","onInitEditMode","setLegendWidthForLegacyBrowser","addEditorTab","unitFormats","getUnitFormats","subItem","value","render","series","color","alias","data","parseSeries","map","serie","i","stats","colors","legendData","dataList","seriesHandler","seriesData","datapoints","target","flotpairs","getFlotPairs","isNumber","decimals","scaledDecimals","delta","dec","Math","floor","log","LN10","magn","pow","norm","size","result","max","decimalInfo","getDecimalsForValue","formatFunc","valueFormats","scope","elem","attrs","ctrl","isIE11","window","MSInputMethodContext","document","documentMode","sideWidth","templateUrl"],"mappings":"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","sourcesContent":["import {MetricsPanelCtrl} from 'app/plugins/sdk';\r\nimport _ from 'lodash';\r\nimport kbn from 'app/core/utils/kbn';\r\nimport TimeSeries from 'app/core/time_series';\r\nimport rendering from './rendering';\r\nimport legend from './legend';\r\n\r\nexport class PieChartCtrl extends MetricsPanelCtrl {\r\n\r\n  constructor($scope, $injector, $rootScope) {\r\n    super($scope, $injector);\r\n    this.$rootScope = $rootScope;\r\n    this.hiddenSeries = {};\r\n\r\n    var panelDefaults = {\r\n      pieType: 'pie',\r\n      legend: {\r\n        show: true, // disable/enable legend\r\n        values: true\r\n      },\r\n      links: [],\r\n      datasource: null,\r\n      maxDataPoints: 3,\r\n      interval: null,\r\n      targets: [{}],\r\n      cacheTimeout: null,\r\n      nullPointMode: 'connected',\r\n      legendType: 'Under graph',\r\n      breakPoint: '50%',\r\n      aliasColors: {},\r\n      format: 'short',\r\n      valueName: 'current',\r\n      strokeWidth: 1,\r\n      fontSize: '80%',\r\n      combine: {\r\n        threshold: 0.0,\r\n        label: 'Others'\r\n      }\r\n    };\r\n\r\n    _.defaults(this.panel, panelDefaults);\r\n    _.defaults(this.panel.legend, panelDefaults.legend);\r\n\r\n    this.events.on('render', this.onRender.bind(this));\r\n    this.events.on('data-received', this.onDataReceived.bind(this));\r\n    this.events.on('data-error', this.onDataError.bind(this));\r\n    this.events.on('data-snapshot-load', this.onDataReceived.bind(this));\r\n    this.events.on('init-edit-mode', this.onInitEditMode.bind(this));\r\n\r\n    this.setLegendWidthForLegacyBrowser();\r\n  }\r\n\r\n  onInitEditMode() {\r\n    this.addEditorTab('Options', 'public/plugins/grafana-piechart-panel/editor.html', 2);\r\n    this.unitFormats = kbn.getUnitFormats();\r\n  }\r\n\r\n  setUnitFormat(subItem) {\r\n    this.panel.format = subItem.value;\r\n    this.render();\r\n  }\r\n\r\n  onDataError() {\r\n    this.series = [];\r\n    this.render();\r\n  }\r\n\r\n  changeSeriesColor(series, color) {\r\n    series.color = color;\r\n    this.panel.aliasColors[series.alias] = series.color;\r\n    this.render();\r\n  }\r\n\r\n  onRender() {\r\n    this.data = this.parseSeries(this.series);\r\n  }\r\n\r\n  parseSeries(series) {\r\n    return _.map(this.series, (serie, i) => {\r\n      return {\r\n        label: serie.alias,\r\n        data: serie.stats[this.panel.valueName],\r\n        color: this.panel.aliasColors[serie.alias] || this.$rootScope.colors[i],\r\n        legendData: serie.stats[this.panel.valueName],\r\n      };\r\n    });\r\n  }\r\n\r\n  onDataReceived(dataList) {\r\n    this.series = dataList.map(this.seriesHandler.bind(this));\r\n    this.data = this.parseSeries(this.series);\r\n    this.render(this.data);\r\n  }\r\n\r\n  seriesHandler(seriesData) {\r\n    var series = new TimeSeries({\r\n      datapoints: seriesData.datapoints,\r\n      alias: seriesData.target\r\n    });\r\n\r\n    series.flotpairs = series.getFlotPairs(this.panel.nullPointMode);\r\n    return series;\r\n  }\r\n\r\n  getDecimalsForValue(value) {\r\n    if (_.isNumber(this.panel.decimals)) {\r\n      return { decimals: this.panel.decimals, scaledDecimals: null };\r\n    }\r\n\r\n    var delta = value / 2;\r\n    var dec = -Math.floor(Math.log(delta) / Math.LN10);\r\n\r\n    var magn = Math.pow(10, -dec);\r\n    var norm = delta / magn; // norm is between 1.0 and 10.0\r\n    var size;\r\n\r\n    if (norm < 1.5) {\r\n      size = 1;\r\n    } else if (norm < 3) {\r\n      size = 2;\r\n      // special case for 2.5, requires an extra decimal\r\n      if (norm > 2.25) {\r\n        size = 2.5;\r\n        ++dec;\r\n      }\r\n    } else if (norm < 7.5) {\r\n      size = 5;\r\n    } else {\r\n      size = 10;\r\n    }\r\n\r\n    size *= magn;\r\n\r\n    // reduce starting decimals if not needed\r\n    if (Math.floor(value) === value) { dec = 0; }\r\n\r\n    var result = {};\r\n    result.decimals = Math.max(0, dec);\r\n    result.scaledDecimals = result.decimals - Math.floor(Math.log(size) / Math.LN10) + 2;\r\n\r\n    return result;\r\n  }\r\n\r\n  formatValue(value) {\r\n    var decimalInfo = this.getDecimalsForValue(value);\r\n    var formatFunc = kbn.valueFormats[this.panel.format];\r\n    if (formatFunc) {\r\n      return formatFunc(value, decimalInfo.decimals, decimalInfo.scaledDecimals);\r\n    }\r\n    return value;\r\n  }\r\n\r\n  link(scope, elem, attrs, ctrl) {\r\n    rendering(scope, elem, attrs, ctrl);\r\n  }\r\n\r\n  toggleSeries(serie) {\r\n    if (this.hiddenSeries[serie.label]) {\r\n      delete this.hiddenSeries[serie.label];\r\n    } else {\r\n      this.hiddenSeries[serie.label] = true;\r\n    }\r\n    this.render();\r\n  }\r\n\r\n  onLegendTypeChanged() {\r\n    this.setLegendWidthForLegacyBrowser();\r\n    this.render();\r\n  }\r\n\r\n  setLegendWidthForLegacyBrowser() {\r\n    var isIE11 = !!window.MSInputMethodContext && !!document.documentMode;\r\n    if (isIE11 && this.panel.legendType === 'Right side' && !this.panel.legend.sideWidth) {\r\n      this.panel.legend.sideWidth = 150;\r\n    }\r\n  }\r\n}\r\n\r\nPieChartCtrl.templateUrl = 'module.html';\r\n"],"file":"piechart_ctrl.js"}