{"version":3,"sources":["../src/rendering.js"],"names":["link","scope","elem","attrs","ctrl","data","panel","find","$tooltip","$","events","on","render","getLegendHeight","panelHeight","legend","show","legendType","percentage","values","breakPoint","parseInt","total","length","Math","min","floor","formatter","label","slice","slice_data","decimal","start","fontSize","color","percentageDecimals","formatValue","percent","toFixed","noDataPoints","html","addPieChart","width","height","size","plotCanvas","plotCss","margin","position","paddingBottom","css","backgroundColor","options","series","pie","stroke","parseFloat","strokeWidth","highlight","opacity","combine","threshold","grid","hoverable","clickable","pieType","innerRadius","i","hiddenSeries","sort","valueName","sortDesc","a","b","legendData","plot","bind","event","pos","item","detach","body","formatted","place_tt","pageX","pageY","renderingCompleted","_"],"mappings":"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","sourcesContent":["import _ from 'lodash';\r\nimport $ from 'jquery';\r\nimport 'jquery.flot';\r\nimport 'jquery.flot.pie';\r\n\r\nexport default function link(scope, elem, attrs, ctrl) {\r\n  var data, panel;\r\n  elem = elem.find('.piechart-panel__chart');\r\n  var $tooltip = $('<div id=\"tooltip\">');\r\n\r\n  ctrl.events.on('render', function () {\r\n    render();\r\n  });\r\n\r\n  function getLegendHeight(panelHeight) {\r\n    if (!ctrl.panel.legend.show || ctrl.panel.legendType === 'Right side' || ctrl.panel.legendType === 'On graph') {\r\n      return 20;\r\n    }\r\n\r\n    if (ctrl.panel.legendType == 'Under graph' && ctrl.panel.legend.percentage || ctrl.panel.legend.values) {\r\n      let breakPoint = parseInt(ctrl.panel.breakPoint) / 100;\r\n      var total = 23 + 20 * data.length;\r\n      return Math.min(total, Math.floor(panelHeight * breakPoint));\r\n    }\r\n  }\r\n\r\n  function formatter(label, slice) {\r\n    var slice_data = slice.data[0][slice.data[0].length - 1];\r\n    var decimal = 2;\r\n    var start = \"<div style='font-size:\" + ctrl.panel.fontSize + \";text-align:center;padding:2px;color:\" + slice.color + \";'>\" + label + \"<br/>\";\r\n\r\n    if (ctrl.panel.legend.percentageDecimals) {\r\n      decimal = ctrl.panel.legend.percentageDecimals;\r\n    }\r\n    if (ctrl.panel.legend.values && ctrl.panel.legend.percentage) {\r\n      return start + ctrl.formatValue(slice_data) + \"<br/>\" + slice.percent.toFixed(decimal) + \"%</div>\";\r\n    } else if (ctrl.panel.legend.values) {\r\n      return start + ctrl.formatValue(slice_data) + \"</div>\";\r\n    } else if (ctrl.panel.legend.percentage) {\r\n      return start + slice.percent.toFixed(decimal) + \"%</div>\";\r\n    } else {\r\n      return start + '</div>';\r\n    }\r\n  }\r\n\r\n  function noDataPoints() {\r\n    var html = '<div class=\"datapoints-warning\"><span class=\"small\">No data points</span></div>';\r\n    elem.html(html);\r\n  }\r\n\r\n  function addPieChart() {\r\n    var width = elem.width();\r\n    var height = ctrl.height - getLegendHeight(ctrl.height);\r\n\r\n    var size = Math.min(width, height);\r\n\r\n    var plotCanvas = $('<div></div>');\r\n    var plotCss = {\r\n      margin: 'auto',\r\n      position: 'relative',\r\n      paddingBottom: 20 + 'px',\r\n      height: size + 'px'\r\n    };\r\n\r\n    plotCanvas.css(plotCss);\r\n\r\n    var backgroundColor = $('body').css('background-color')\r\n\r\n    var options = {\r\n      legend: {\r\n        show: false\r\n      },\r\n      series: {\r\n        pie: {\r\n          show: true,\r\n          stroke: {\r\n            color: backgroundColor,\r\n            width: parseFloat(ctrl.panel.strokeWidth).toFixed(1)\r\n          },\r\n          label: {\r\n            show: ctrl.panel.legend.show && ctrl.panel.legendType === 'On graph',\r\n            formatter: formatter\r\n          },\r\n          highlight: {\r\n            opacity: 0.0\r\n          },\r\n          combine: {\r\n            threshold: ctrl.panel.combine.threshold,\r\n            label: ctrl.panel.combine.label\r\n          }\r\n        }\r\n      },\r\n      grid: {\r\n        hoverable: true,\r\n        clickable: false\r\n      }\r\n    };\r\n\r\n    if (panel.pieType === 'donut') {\r\n      options.series.pie.innerRadius = 0.5;\r\n    }\r\n\r\n    data = ctrl.data;\r\n\r\n    for (let i = 0; i < data.length; i++) {\r\n      let series = data[i];\r\n\r\n      // if hidden remove points\r\n      if (ctrl.hiddenSeries[series.label]) {\r\n        series.data = {};\r\n      }\r\n    }\r\n\r\n\r\n    if (panel.legend.sort) {\r\n      if (ctrl.panel.valueName !== panel.legend.sort) {\r\n        panel.legend.sort = ctrl.panel.valueName;\r\n      }\r\n      if (panel.legend.sortDesc === true) {\r\n        data.sort(function (a, b) {\r\n          return b.legendData - a.legendData;\r\n        });\r\n      } else {\r\n        data.sort(function (a, b) {\r\n          return a.legendData - b.legendData;\r\n        });\r\n      }\r\n    }\r\n\r\n    elem.html(plotCanvas);\r\n\r\n    $.plot(plotCanvas, data, options);\r\n    plotCanvas.bind(\"plothover\", function (event, pos, item) {\r\n      if (!item) {\r\n        $tooltip.detach();\r\n        return;\r\n      }\r\n\r\n      var body;\r\n      var percent = parseFloat(item.series.percent).toFixed(2);\r\n      var formatted = ctrl.formatValue(item.series.data[0][1]);\r\n\r\n      body = '<div class=\"piechart-tooltip-small\"><div class=\"piechart-tooltip-time\">';\r\n      body += '<div class=\"piechart-tooltip-value\">' + item.series.label + ': ' + formatted;\r\n      body += \" (\" + percent + \"%)\" + '</div>';\r\n      body += \"</div></div>\";\r\n\r\n      $tooltip.html(body).place_tt(pos.pageX + 20, pos.pageY);\r\n    });\r\n  }\r\n\r\n  function render() {\r\n    if (!ctrl.data) { return; }\r\n\r\n    data = ctrl.data;\r\n    panel = ctrl.panel;\r\n\r\n      if (0 == ctrl.data.length) {\r\n        noDataPoints();\r\n      } else {\r\n        addPieChart();\r\n      }\r\n\r\n      ctrl.renderingCompleted();\r\n  }\r\n}\r\n\r\n"],"file":"rendering.js"}